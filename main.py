import os  # –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
import json  # –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏)
import random  # –ú–æ–¥—É–ª—å –¥–ª—è —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª
from gamer import Gamer  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å –∏–≥—Ä–æ–∫–∞
from boss import Boss  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å –≤—Ä–∞–≥–∞
from artefacts import ArtifactBank  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∞–Ω–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤

# –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
SAVE_DIR = "saves"  # –ü–∞–ø–∫–∞, –≥–¥–µ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
USERS_FILE = f"{SAVE_DIR}/users.json"  # –§–∞–π–ª, –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–≥–∏–Ω—ã –∏ –ø–∞—Ä–æ–ª–∏ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤

def ensure_dirs():
    os.makedirs(SAVE_DIR, exist_ok=True)  # –°–æ–∑–¥–∞—ë—Ç –ø–∞–ø–∫—É SAVE_DIR, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç

def get_choice(options):

    #–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞ options.
    #–ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ –Ω–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å.

    while True:
        try:
            choice = int(input("> "))  # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if choice in options:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ –≤ —Å–ø–∏—Å–∫–µ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö
                return choice  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—ã–±–æ—Ä
            print("–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.")  # –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –≤–≤–æ–¥–µ
        except ValueError:
            print("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.")  # –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –≤–≤–µ–ª–∏ –Ω–µ —á–∏—Å–ª–æ

def load_users():
    #–ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ—Ö –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞ JSON
    ensure_dirs()  # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø–∞–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if not os.path.exists(USERS_FILE):
        return {}  # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å
    with open(USERS_FILE, "r", encoding="utf-8") as f:
        return json.load(f)  # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

def save_users(users):
    #–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ñ–∞–π–ª JSON
    ensure_dirs()  # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø–∞–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    with open(USERS_FILE, "w", encoding="utf-8") as f:
        json.dump(users, f, indent=4, ensure_ascii=False)  # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

def register():
    #–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    users = load_users()  # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    name = input("–ò–º—è: ")  # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è
    if name in users:
        print("–ò–≥—Ä–æ–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
        return None
    password = input("–ü–∞—Ä–æ–ª—å: ")  # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å
    users[name] = password  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å
    save_users(users)  # –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    return Gamer(username=name)  # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞

def login():
    #–í—Ö–æ–¥ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–∫–∫–∞—É–Ω—Ç
    users = load_users()  # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    name = input("–ò–º—è: ")  # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è
    password = input("–ü–∞—Ä–æ–ª—å: ")  # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å

    if users.get(name) != password:  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–Ω–∞ –∏ –ø–∞—Ä–æ–ª—è
        print("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.")
        return None

    player = Gamer(username=name)  # –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –∏–≥—Ä–æ–∫–∞
    save_path = f"{SAVE_DIR}/{name}_save.json"  # –ü—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é —ç—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    if os.path.exists(save_path):  # –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –µ—Å—Ç—å
        with open(save_path, "r", encoding="utf-8") as f:
            data = json.load(f)
        player.load_from_dict(data["player"])  # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
        print("–¢—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ—à—å –ø—É—Ç—å –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.")
    return player  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–≥—Ä–æ–∫–∞

#–ö–ª–∞—Å—Å –ò–≥—Ä—ã
class Game:
    def __init__(self, player):
        self.player = player  # –ò–≥—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–π —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –∏–≥—Ä–µ
        self.artifacts = ArtifactBank()  # –ë–∞–Ω–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        self.visited_secret_rooms = set()  # –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â—ë–Ω–Ω—ã—Ö —Ç–∞–π–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç, —á—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –ø—Ä–æ–π—Ç–∏ –¥–≤–∞–∂–¥—ã

    def save_game(self):
        #–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–≥—Ä–æ–∫–∞
        path = f"{SAVE_DIR}/{self.player.username}_save.json"  # –§–∞–π–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
        with open(path, "w", encoding="utf-8") as f:
            json.dump({"player": self.player.to_dict()}, f, indent=4, ensure_ascii=False)
        print("\n –ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.")  # –°–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫—É

    def find_artifact(self, place):
        #–ò–≥—Ä–æ–∫ –Ω–∞—Ö–æ–¥–∏—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
        artifact = self.artifacts.get_random_artifact()  # –ë–µ—Ä—ë–º —Å–ª—É—á–∞–π–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –∏–∑ –±–∞–Ω–∫–∞
        print(f"\n –í {place} —Ç—ã –Ω–∞—Ö–æ–¥–∏—à—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç!")
        self.player.add_artifact(artifact)  # –î–æ–±–∞–≤–ª—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –∏–≥—Ä–æ–∫—É –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

    def battle(self, enemy):
            print(f"\nÔ∏è –¢—ã —Å—Ç–∞–ª–∫–∏–≤–∞–µ—à—å—Å—è —Å –≤—Ä–∞–≥–æ–º: {enemy.name}")
            while enemy.hp > 0 and self.player.health > 0:  # –ü–æ–∫–∞ –æ–±–∞ –∂–∏–≤—ã
                # --- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---

                self.player.show_full_stats()  # –ü–æ–∫–∞–∑–∞—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ, –∞—Ç–∞–∫—É –∏ –∑–∞—â–∏—Ç—É
                print(f"{enemy.name}: {enemy.hp}/{enemy.max_hp}\n")  # –ó–¥–æ—Ä–æ–≤—å–µ –≤—Ä–∞–≥–∞

                # --- –í—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏–π ---
                print("1. –ê—Ç–∞–∫–æ–≤–∞—Ç—å")
                print("2. –°–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É")
                print("3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è")
                choice = get_choice([1, 2, 3])

                if choice == 2:
                    continue  # –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, —Ö–æ–¥ –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—Å—è
                if choice == 3:
                    self.save_game()
                    continue  # –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–≥—Ä–æ–∫ –¥–µ–ª–∞–µ—Ç —Ö–æ–¥ –∑–∞–Ω–æ–≤–æ

                # –ò–≥—Ä–æ–∫ –∞—Ç–∞–∫—É–µ—Ç
                enemy.take_damage(self.player.attack)
                print(f"–¢—ã –Ω–∞–Ω–æ—Å–∏—à—å {self.player.attack} —É—Ä–æ–Ω–∞ {enemy.name}!")

                # –í—Ä–∞–≥ –∞—Ç–∞–∫—É–µ—Ç
                if enemy.hp > 0:
                    damage = max(0, enemy.attack - self.player.defense)  # –£—Ä–æ–Ω —Å —É—á—ë—Ç–æ–º –∑–∞—â–∏—Ç—ã
                    self.player.health -= damage
                    print(f"{enemy.name} –∞—Ç–∞–∫—É–µ—Ç –∏ –Ω–∞–Ω–æ—Å–∏—Ç {damage} —É—Ä–æ–Ω–∞!")

            if self.player.health <= 0:
                print("\n –¢—ã –ø–æ–≥–∏–± –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ.")  # –ü—Ä–æ–∏–≥—Ä—ã—à
                return False

            print(f"\n {enemy.name} –ø–æ–±–µ–∂–¥—ë–Ω!")  # –ü–æ–±–µ–¥–∞
            self.find_artifact(enemy.name)  # –ü–æ—Å–ª–µ –ø–æ–±–µ–¥—ã –∏–≥—Ä–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
            return True

    def secret_room(self, zone):
            """–ú–µ—Ö–∞–Ω–∏–∫–∞ —Ç–∞–π–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã —Å —à–∞–Ω—Å–æ–º 50%"""
            if zone in self.visited_secret_rooms:
                return  # –ï—Å–ª–∏ —É–∂–µ –±—ã–ª, –Ω–µ –¥–∞—ë–º –ø–æ–≤—Ç–æ—Ä–Ω–æ
            if random.random() < 0.5:  # 50% —à–∞–Ω—Å –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
                print(f"\n –¢—ã –∑–∞–º–µ—á–∞–µ—à—å —Å—Ç—Ä–∞–Ω–Ω—É—é –¥–≤–µ—Ä—å –≤ —Å—Ç–µ–Ω–µ –∑–æ–Ω—ã {zone}...")
                print("1. –û—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–º–Ω–∞—Ç—É")
                print("2. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—É—Ç—å")
                choice = get_choice([1, 2])
                if choice == 1:
                    self.find_artifact(f"—Ç–∞–π–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ –∑–æ–Ω—ã {zone}")  # –ù–∞—Ö–æ–¥–∏–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
                self.visited_secret_rooms.add(zone)  # –ü–æ–º–µ—á–∞–µ–º –∫–æ–º–Ω–∞—Ç—É –∫–∞–∫ –ø–æ—Å–µ—â—ë–Ω–Ω—É—é

        # ---------- –°—é–∂–µ—Ç–Ω—ã–µ –≤–µ—Ç–∫–∏ ----------
    def start(self):
            """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å—é–∂–µ—Ç–∞"""
            print("""
        –¢—ã ‚Äî –≥–ª–∞–¥–∏–∞—Ç–æ—Ä, –æ–∫–∞–∑–∞–≤—à–∏–π—Å—è –≤ –ª–∞–±–∏—Ä–∏–Ω—Ç–µ –ö—Ä–∏—Ç–∞.
        –ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π ‚Äî —Ç—å–º–∞ –∏ —Ä–µ–≤ —Ç–æ–ª–ø—ã –Ω–∞–¥ –∞—Ä–µ–Ω–æ–π.
        """)

            # ---------- –ó–æ–Ω–∞ 1 ----------
            print("\n–ó–æ–Ω–∞ 1: –ö–∞–º–µ–Ω–Ω—ã–µ –∫–æ—Ä–∏–¥–æ—Ä—ã")
            self.secret_room(1)  # –¢–∞–π–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞
            enemy1 = Boss("–ö–∞–º–µ–Ω–Ω—ã–π —Å—Ç—Ä–∞–∂", 100, 100, 20)
            if not self.battle(enemy1):  # –ë–æ–π
                return  # –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ —É–º–µ—Ä, –∏–≥—Ä–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è

            # ---------- –ó–æ–Ω–∞ 2 ----------
            print("\n–ó–æ–Ω–∞ 2: –ü–æ–¥–∑–µ–º–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã")
            self.secret_room(2)
            enemy2 = Boss("–ü—Ä–æ–∫–ª—è—Ç—ã–π –≤–æ–∏–Ω", 120, 120, 25)
            if not self.battle(enemy2):
                return

            # ---------- –ó–æ–Ω–∞ 3 ----------
            print("\n–ó–æ–Ω–∞ 3: –ó–∞–ª –¢–µ–Ω–µ–π")
            self.secret_room(3)
            enemy3 = Boss("–¢–µ–Ω–µ–≤–æ–π –≥–ª–∞–¥–∏–∞—Ç–æ—Ä", 140, 140, 30)
            if not self.battle(enemy3):
                return

            # ---------- –ó–æ–Ω–∞ 4 ----------
            print("\n–ó–æ–Ω–∞ 4: –†–µ–∫–∞ –õ–∞–±–∏—Ä–∏–Ω—Ç–∞")
            self.secret_room(4)
            enemy4 = Boss("–í–æ–¥–Ω—ã–π –º–æ–Ω—Å—Ç—Ä", 160, 160, 30)
            if not self.battle(enemy4):
                return

            # ---------- –ó–æ–Ω–∞ 5 ----------
            print("\n–ó–æ–Ω–∞ 5: –°—Ç–µ–Ω—ã –ü–∞—Å—Ç–µ–π")
            self.secret_room(5)
            enemy5 = Boss("–°—Ç—Ä–∞–∂ –õ–∞–±–∏—Ä–∏–Ω—Ç–∞", 180, 180, 36)
            if not self.battle(enemy5):
                return

            # ---------- –ó–æ–Ω–∞ 6 ----------
            print("\n–ó–æ–Ω–∞ 6: –°–µ—Ä–¥—Ü–µ –õ–∞–±–∏—Ä–∏–Ω—Ç–∞")
            self.secret_room(6)
            boss = Boss("–ú–∏–Ω–æ—Ç–∞–≤—Ä", 350, 350, 50)
            if not self.battle(boss):
                return

            print("\nüåü –¢—ã –ø–æ–±–µ–¥–∏–ª –ú–∏–Ω–æ—Ç–∞–≤—Ä–∞ –∏ —Å–æ–±—Ä–∞–ª –≤—Å–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã!")
            print("–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –∫–æ–Ω—Ü–æ–≤–∫–∞: —Ç—ã –ø–æ–∫–∏–¥–∞–µ—à—å –ª–∞–±–∏—Ä–∏–Ω—Ç –≥–µ—Ä–æ–µ–º!")
            self.save_game()  # –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
# –ó–ê–ü–£–°–ö –ò–ì–†–´
ensure_dirs()  # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π

player = None
while not player:
    print("\n1. –í—Ö–æ–¥")
    print("2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è")
    choice = get_choice([1,2])
    if choice == 1:
        player = login()  # –í—Ö–æ–¥
    else:
        player = register()  # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
Game(player).start()  # –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã